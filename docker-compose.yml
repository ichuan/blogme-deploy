version: '3.4'

x-server-tune:
  &server-tune
  restart: always
  sysctls:
    - net.core.somaxconn=65535
  ulimits:
    nproc: 65535
    nofile: 500000

services:
  db:
    << : *server-tune
    image: mysql:5.7
    expose:
      - '3306'
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      MYSQL_ROOT_PASSWORD: ''
    volumes:
      - "./data/mysql:/var/lib/mysql"
  ui:
    << : *server-tune
    image: nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - "./data/nginx.conf:/etc/nginx/nginx.conf"
      - "./data/nginx:/etc/nginx/conf.d"
      - "./data/letsencrypt:/etc/letsencrypt"
      - "./data/ui:/www"
      - "./data/api1/public:/public/api1"
    depends_on:
      - api1
  api1:
    << : *server-tune
    # image: docker.pkg.github.com/ichuan/blogme-api/xinyi
    image: ichuan/blogme-api
    environment:
      DB_HOST: 'db'
      DB_NAME: 'api1'
      # generated using: openssl rand -hex 32
      SECRET_KEY: '5705cd149afab05e90716f6651db8b0c63975dafab435df84f78adddcedb5a05'
      CORS_ORIGINS: 'https://yanxinyi.me'
    expose:
      - '8000'
    volumes:
      - "./data/api1/public:/app/blogme/public"
      - "./data/api1/logs:/app/logs"
    depends_on:
      - db
